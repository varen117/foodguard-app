# FoodGuard æ•°æ®åº“é›†æˆå®Œæˆæ€»ç»“

## ğŸ¯ é¡¹ç›®æ¦‚è¿°
å·²æˆåŠŸå®Œæˆ FoodGuard é£Ÿå“å®‰å…¨æ²»ç†ç³»ç»Ÿçš„å‰ç«¯ä¸ PostgreSQL æ•°æ®åº“é›†æˆï¼Œå®ç°äº†ä»æ™ºèƒ½åˆçº¦äº‹ä»¶åˆ°å‰ç«¯æ•°æ®å±•ç¤ºçš„å®Œæ•´æ•°æ®æµã€‚

## ğŸ“Š ç³»ç»Ÿæ¶æ„

### æ•°æ®æµæ¶æ„
```
æ™ºèƒ½åˆçº¦ â†’ Rindexer ç´¢å¼•å™¨ â†’ PostgreSQL æ•°æ®åº“ â†’ Next.js API â†’ React å‰ç«¯
```

### æ ¸å¿ƒç»„ä»¶
1. **æ™ºèƒ½åˆçº¦**: éƒ¨ç½²åœ¨ Anvil æœ¬åœ°é“¾ (Chain ID: 31337)
2. **Rindexer ç´¢å¼•å™¨**: ç›‘å¬å¹¶ç´¢å¼•åˆçº¦äº‹ä»¶åˆ° PostgreSQL
3. **PostgreSQL æ•°æ®åº“**: å­˜å‚¨äº‹ä»¶æ•°æ® (ç«¯å£: 5440)
4. **Next.js API**: æä¾›æ•°æ®åº“æŸ¥è¯¢æ¥å£
5. **React å‰ç«¯**: å±•ç¤ºå®æ—¶æ•°æ®

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

### ä¸»è¦ Schema å’Œè¡¨
1. **food_guard_indexer_food_safety_governance**
   - `complaint_created`: æŠ•è¯‰åˆ›å»ºäº‹ä»¶
   - `case_status_updated`: æ¡ˆä»¶çŠ¶æ€æ›´æ–°äº‹ä»¶

2. **food_guard_indexer_participant_pool_manager**
   - `user_registered`: ç”¨æˆ·æ³¨å†Œäº‹ä»¶

3. **food_guard_indexer_fund_manager**
   - `deposit_made`: ä¿è¯é‡‘å­˜å…¥äº‹ä»¶

4. **food_guard_indexer_voting_dispute_manager**
   - `vote_submitted`: æŠ•ç¥¨æäº¤äº‹ä»¶

5. **food_guard_indexer_reward_punishment_manager**
   - `reward_distributed`: å¥–åŠ±åˆ†å‘äº‹ä»¶
   - `punishment_executed`: å¤„ç½šæ‰§è¡Œäº‹ä»¶

## ğŸ› ï¸ å·²å®ç°åŠŸèƒ½

### 1. æ•°æ®åº“è¿æ¥æœåŠ¡ (`src/lib/database.ts`)
```typescript
export class DatabaseService {
  // æ‰§è¡ŒåŸç”Ÿ SQL æŸ¥è¯¢
  static async query(text: string, params?: any[]): Promise<any>
  
  // è·å–ç”¨æˆ·æ³¨å†Œä¿¡æ¯
  static async getUserRegistration(address: string)
  
  // è·å–ç”¨æˆ·ä¿è¯é‡‘è®°å½•
  static async getUserDeposits(address: string)
  
  // è·å–æŠ•è¯‰åˆ›å»ºè®°å½•
  static async getComplaintsByUser(address: string)
  
  // è·å–æ¡ˆä»¶çŠ¶æ€æ›´æ–°è®°å½•
  static async getCaseStatusUpdates(caseId?: number)
  
  // è·å–æŠ•ç¥¨è®°å½•
  static async getUserVotes(address: string)
  
  // è·å–å¥–æƒ©è®°å½•
  static async getUserRewards(address: string)
  static async getUserPunishments(address: string)
  
  // è·å–æ‰€æœ‰æ¡ˆä»¶åˆ—è¡¨
  static async getAllCases(limit: number = 50, offset: number = 0)
  
  // è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
  static async getUserStats(address: string)
  
  // æµ‹è¯•æ•°æ®åº“è¿æ¥
  static async testConnection()
}
```

### 2. API è·¯ç”± (Next.js App Router)
- **`/api/database/test`**: æµ‹è¯•æ•°æ®åº“è¿æ¥
- **`/api/database/schema`**: æŸ¥çœ‹è¡¨ç»“æ„ (æ”¯æŒä¸åŒ schema)
- **`/api/user/stats`**: è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
- **`/api/user/cases`**: è·å–ç”¨æˆ·å‚ä¸çš„æ¡ˆä»¶
- **`/api/cases`**: è·å–æ‰€æœ‰æ¡ˆä»¶åˆ—è¡¨

### 3. React Hooks (`src/hooks/useDatabase.ts`)
```typescript
// æ•°æ®åº“è¿æ¥æµ‹è¯•
export function useDatabaseTest()

// è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
export function useUserStats(address?: string)

// è·å–ç”¨æˆ·å‚ä¸çš„æ¡ˆä»¶
export function useUserCases(address?: string)

// è·å–æ‰€æœ‰æ¡ˆä»¶åˆ—è¡¨
export function useAllCases(limit: number = 50, offset: number = 0)
```

### 4. å‰ç«¯é¡µé¢é›†æˆ
- **ä¸ªäººä¸­å¿ƒé¡µé¢** (`/profile`): æ˜¾ç¤ºçœŸå®çš„æ•°æ®åº“ç»Ÿè®¡æ•°æ®
- **æ•°æ®åº“æµ‹è¯•é¡µé¢** (`/database-test`): å®Œæ•´çš„æ•°æ®åº“åŠŸèƒ½æµ‹è¯•ç•Œé¢

## ğŸ“ˆ å®æ—¶æ•°æ®å±•ç¤º

### ä¸ªäººä¸­å¿ƒç»Ÿè®¡æ•°æ®
- âœ… åˆ›å»ºæŠ•è¯‰æ•°é‡ (ä» `complaint_created` è¡¨æŸ¥è¯¢)
- âœ… æŠ•ç¥¨æ¬¡æ•° (ä» `vote_submitted` è¡¨æŸ¥è¯¢)
- âœ… ä¿è¯é‡‘æ¬¡æ•° (ä» `deposit_made` è¡¨æŸ¥è¯¢)
- âœ… å¯ç”¨ä¿è¯é‡‘ (ä»æ™ºèƒ½åˆçº¦å®æ—¶æŸ¥è¯¢)
- âœ… ç”¨æˆ·è§’è‰²å’Œä¿¡èª‰åˆ†æ•° (ä»é“¾ä¸Šæ•°æ®è·å–)

### æ´»åŠ¨è®°å½•
- âœ… ä¿è¯é‡‘æ“ä½œå†å²
- âœ… æŠ•ç¥¨æ´»åŠ¨è®°å½•
- âœ… å¥–åŠ±åˆ†å‘è®°å½•
- âœ… æŒ‰æ—¶é—´æ’åºæ˜¾ç¤º

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

### æ•°æ®åº“æµ‹è¯•é¡µé¢ (`/database-test`)
æä¾›å®Œæ•´çš„æ•°æ®åº“åŠŸèƒ½æµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š
- æ•°æ®åº“è¿æ¥çŠ¶æ€æ£€æŸ¥
- ç”¨æˆ·ç»Ÿè®¡æ•°æ®æŸ¥è¯¢æµ‹è¯•
- ç”¨æˆ·æ¡ˆä»¶æ•°æ®æŸ¥è¯¢æµ‹è¯•
- æ¡ˆä»¶åˆ—è¡¨æŸ¥è¯¢æµ‹è¯•
- å®æ—¶çŠ¶æ€æŒ‡ç¤ºå™¨
- JSON æ ¼å¼æ•°æ®å±•ç¤º

### æµ‹è¯•ç”¨æˆ·æ•°æ®
ç³»ç»Ÿä¸­å·²æœ‰æµ‹è¯•æ•°æ®ï¼š
- æµ‹è¯•åœ°å€: `0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266`
- ç”¨æˆ·è§’è‰²: ENTERPRISE (role: 1)
- ä¿è¯é‡‘è®°å½•: 1 ç¬” (0.1 ETH)
- æ³¨å†Œæ—¶é—´: åŒºå— #405

## ğŸ”§ æŠ€æœ¯ç‰¹æ€§

### æ•°æ®å¤„ç†
- **BigInt æ”¯æŒ**: æ­£ç¡®å¤„ç†ä»¥å¤ªåŠå¤§æ•°å€¼
- **æ—¶é—´æˆ³è½¬æ¢**: Unix æ—¶é—´æˆ³åˆ° JavaScript Date è½¬æ¢
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ•è·å’Œç”¨æˆ·åé¦ˆ
- **æ•°æ®éªŒè¯**: API å‚æ•°éªŒè¯å’Œæ•°æ®æ ¼å¼æ£€æŸ¥

### æ€§èƒ½ä¼˜åŒ–
- **å¹¶è¡ŒæŸ¥è¯¢**: ä½¿ç”¨ Promise.all è¿›è¡Œå¤šè¡¨æŸ¥è¯¢
- **è¿æ¥æ± **: PostgreSQL è¿æ¥æ± ç®¡ç†
- **ç¼“å­˜ç­–ç•¥**: React Query ç¼“å­˜å’Œé‡è¯•æœºåˆ¶
- **åˆ†é¡µæ”¯æŒ**: æ¡ˆä»¶åˆ—è¡¨åˆ†é¡µæŸ¥è¯¢

### å®‰å…¨æ€§
- **å‚æ•°åŒ–æŸ¥è¯¢**: é˜²æ­¢ SQL æ³¨å…¥
- **åœ°å€è§„èŒƒåŒ–**: ç»Ÿä¸€è½¬æ¢ä¸ºå°å†™æ ¼å¼
- **è¿æ¥è¶…æ—¶**: æ•°æ®åº“è¿æ¥è¶…æ—¶ä¿æŠ¤

## ğŸŒ è®¿é—®åœ°å€

### æœ¬åœ°å¼€å‘ç¯å¢ƒ
- **å‰ç«¯åº”ç”¨**: http://localhost:3000
- **ä¸ªäººä¸­å¿ƒ**: http://localhost:3000/profile
- **æ•°æ®åº“æµ‹è¯•**: http://localhost:3000/database-test
- **æ•°æ®åº“**: PostgreSQL (127.0.0.1:5440)
- **åŒºå—é“¾**: Anvil (127.0.0.1:8545)

### API ç«¯ç‚¹
- **æ•°æ®åº“æµ‹è¯•**: `GET /api/database/test`
- **è¡¨ç»“æ„æŸ¥è¯¢**: `GET /api/database/schema?schema=<schema>&table=<table>`
- **ç”¨æˆ·ç»Ÿè®¡**: `GET /api/user/stats?address=<address>`
- **ç”¨æˆ·æ¡ˆä»¶**: `GET /api/user/cases?address=<address>`
- **æ¡ˆä»¶åˆ—è¡¨**: `GET /api/cases?limit=<limit>&offset=<offset>`

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. å¯åŠ¨æ‰€æœ‰æœåŠ¡
```bash
# å¯åŠ¨ Anvil åŒºå—é“¾
anvil --host 0.0.0.0 --port 8545

# å¯åŠ¨ PostgreSQL æ•°æ®åº“
cd foodguard-indexer && docker-compose up -d

# å¯åŠ¨ Rindexer ç´¢å¼•å™¨
cd foodguard-indexer && rindexer start indexer

# å¯åŠ¨å‰ç«¯åº”ç”¨
cd foodguard-app && pnpm run dev
```

### 2. æµ‹è¯•æ•°æ®åº“åŠŸèƒ½
1. è®¿é—® http://localhost:3000/database-test
2. æŸ¥çœ‹æ‰€æœ‰æµ‹è¯•é¡¹ç›®çš„çŠ¶æ€
3. æ£€æŸ¥ JSON æ•°æ®æ˜¯å¦æ­£ç¡®è¿”å›

### 3. æŸ¥çœ‹ä¸ªäººä¸­å¿ƒ
1. è¿æ¥ MetaMask åˆ°æœ¬åœ° Anvil ç½‘ç»œ
2. ä½¿ç”¨æµ‹è¯•è´¦æˆ·æˆ–æ³¨å†Œæ–°è´¦æˆ·
3. è®¿é—® http://localhost:3000/profile
4. æŸ¥çœ‹å®æ—¶çš„ç»Ÿè®¡æ•°æ®å’Œæ´»åŠ¨è®°å½•

## ğŸ“‹ ä¸‹ä¸€æ­¥åŠŸèƒ½æ‰©å±•

### å¯èƒ½çš„å¢å¼ºåŠŸèƒ½
1. **å®æ—¶æ•°æ®æ›´æ–°**: WebSocket æˆ– Server-Sent Events
2. **æ•°æ®åˆ†æé¢æ¿**: å›¾è¡¨å’Œç»Ÿè®¡æŠ¥è¡¨
3. **é«˜çº§æœç´¢**: å¤šæ¡ä»¶ç­›é€‰å’Œæ’åº
4. **æ•°æ®å¯¼å‡º**: CSV/Excel å¯¼å‡ºåŠŸèƒ½
5. **ç¼“å­˜ä¼˜åŒ–**: Redis ç¼“å­˜å±‚
6. **ç›‘æ§å‘Šè­¦**: æ•°æ®åº“æ€§èƒ½ç›‘æ§

### æ•°æ®åº“è¡¨æ‰©å±•
1. **ç”¨æˆ·è¯¦ç»†ä¿¡æ¯è¡¨**: å­˜å‚¨ç”¨æˆ·ä¸ªäººèµ„æ–™
2. **ç³»ç»Ÿæ—¥å¿—è¡¨**: è®°å½•ç³»ç»Ÿæ“ä½œæ—¥å¿—
3. **é…ç½®ç®¡ç†è¡¨**: åŠ¨æ€ç³»ç»Ÿé…ç½®
4. **é€šçŸ¥è®°å½•è¡¨**: ç”¨æˆ·é€šçŸ¥å†å²

## âœ… éªŒè¯æ¸…å•

- [x] PostgreSQL æ•°æ®åº“æ­£å¸¸è¿è¡Œ
- [x] Rindexer ç´¢å¼•å™¨æˆåŠŸç´¢å¼•äº‹ä»¶
- [x] æ‰€æœ‰ API ç«¯ç‚¹æ­£å¸¸å“åº”
- [x] å‰ç«¯é¡µé¢æ­£ç¡®æ˜¾ç¤ºæ•°æ®
- [x] æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡
- [x] ç”¨æˆ·ç»Ÿè®¡æ•°æ®å‡†ç¡®
- [x] å®æ—¶æ•°æ®åŒæ­¥æ­£å¸¸
- [x] é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
- [x] æ–‡æ¡£å’Œæµ‹è¯•é¡µé¢å®Œæ•´

## ğŸ‰ æ€»ç»“

FoodGuard ç³»ç»Ÿå·²æˆåŠŸå®ç°äº†å®Œæ•´çš„æ•°æ®åº“é›†æˆï¼Œä»æ™ºèƒ½åˆçº¦äº‹ä»¶åˆ°å‰ç«¯å±•ç¤ºå½¢æˆäº†å®Œæ•´çš„æ•°æ®æµã€‚ç³»ç»Ÿå…·å¤‡äº†å®æ—¶æ•°æ®æŸ¥è¯¢ã€ç”¨æˆ·ç»Ÿè®¡ã€æ´»åŠ¨è®°å½•ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ºé£Ÿå“å®‰å…¨æ²»ç†æä¾›äº†å¼ºå¤§çš„æ•°æ®æ”¯æŒã€‚

æ‰€æœ‰åŠŸèƒ½éƒ½ç»è¿‡æµ‹è¯•éªŒè¯ï¼Œå¯ä»¥ç«‹å³æŠ•å…¥ä½¿ç”¨ã€‚ç³»ç»Ÿæ¶æ„è®¾è®¡åˆç†ï¼Œå…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ã€‚ 